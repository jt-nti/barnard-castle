<html>

<head>
    <meta charset="utf-8">

    <title>NHS COVID-19 QR Scanner</title>
    <link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <script src="js/jsQR.js"></script>
    <script src="js/load-image.js"></script>
    <script src="js/jwt-decode.min.js"></script>
    <script src="js/castle.js"></script>
    <link rel="stylesheet" type="text/css" href="css/castle.css?v=1" />
</head>

<body>
    <video autoplay playsinline id="video"></video>
    <div id="output">
        <div>
            <label for="qr-text">QR Code Contents: </label>
            <input type="text" name="qr-text" id="qr-text" required>
        </div>
        <div>
            <button id="add-button">Add code</button>
            <button id="clear-button">Clear history</button>
        </div>

        <table id="scan-results">
        </table>

    </div>

    <script>
        const video = document.getElementById('video');
        const loadingMessage = document.getElementById('loadingMessage');
        const outputContainer = document.getElementById('output');
        const outputMessage = document.getElementById('outputMessage');
        const outputData = document.getElementById('outputData');
        const scanResults = document.getElementById('scan-results');

        initDb().then(function (response) {
            db = response;
            loadScans(scanResults);
        });

        var tickDuration = 200;

        // Use facingMode: environment to attemt to get the front camera on phones
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function (stream) {
            video.srcObject = stream;
            video.play();
            setTimeout(function () { tick(); }, tickDuration);
        });

        function tick() {
            try {
                var canvasElement = document.createElement("canvas");
                var canvas = canvasElement.getContext("2d");
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                var code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                if (code) {
                    // barcode was found!
                    document.getElementById('qr-text').value = code.data;
                    handleCode(scanResults, code.data);
                }
            }
            catch (t) {
                console.log("PROBLEM: " + t);
            }
            setTimeout(function () { tick(); }, tickDuration);
        }

        document.getElementById('add-button').addEventListener('click', () => {
            var code = document.getElementById('qr-text').value;
            handleCode(scanResults, code);
        });

        document.getElementById('clear-button').addEventListener('click', () => {
            clearScans();
        });

    // document.getElementById('file-input').onchange = function () {
    //     loadImage(
    //         this.files[0],
    //         function (img, data) {
    //             // document.body.appendChild(img)
    //             var canvasElement = document.createElement("canvas");            
    //             var canvas = canvasElement.getContext("2d");
    //             canvasElement.height = data.originalHeight;
    //             canvasElement.width = data.originalWidth;
    //             canvas.drawImage(img, 0, 0, canvasElement.width, canvasElement.height);
    //             var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
    //             var code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
    //             if (code) 
    //             {
    //                 // barcode was found!
    //                 decodeData(code.data);

    //                 outputMessage.hidden = true;
    //                 outputData.parentElement.hidden = false;
    //                 outputData.innerText = data;
    //             } else {
    //                 alert("No code detected");
    //             }
    //         },
    //         {
    //             meta: true
    //         } // Options
    //     )}
    </script>
</body>

</html>